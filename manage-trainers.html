<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMS - Manage Trainer's Account</title>
    <link rel="stylesheet" href="trainingmanagement.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" href="/images/favicon.png" type="image/png">
</head>
<body>

<header>
    <div class="container">
        <h1>Training Management System</h1>
    </div>
    <div class="header-menu">
        <a href="index.html">
            <button class="home-button">
                <i class="fas fa-home"></i>
            </button>
        </a>
        <div class="burger-menu">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
</header>
<div class="burger-menu-content">
    <h3>Training Materials</h3>
    <ul class="sub-menu">
        <li><a href="materials.html">Material</a></li>
        <li><a href="certification.html">Certifications</a></li>
        <li><a href="evaluation-questionnaire.html">Evaluation questionnaire</a></li>
        <li><a href="dailyTrainingReport.html">Daily Training Report</a></li>                
    </ul>
    <h3>Training Preparation</h3>
    <ul class="sub-menu">
        <li><a href="training-slots.html">Create Training Slots</a></li>
        <li><a href="tlSlots.html">Assign to Training</a></li>
        <li><a href="training-plan.html">Training Plan</a></li>
        <li><a href="schedule.html">Schedule</a></li>                
    </ul>
    <h3>Accounts</h3>
    <ul class="sub-menu">
        <li><a href="manage-trainers.html">Manage Trainer's Account</a></li>
        <li><a href="agents.html">Manage Agents</a></li>                
    </ul>
    <button class="logout" onclick="logout()">Logout</button>
</div>
<div class="site-content">
    <main>
        <h3 class="page-name">Manage Trainers' Account</h3>    
        <div class="training-slots">
            <div id="import-users">
                <table id="user-table" class="user-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Position</th>
                            <th style="display: none;">Password</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" id="user-name" placeholder="John Doe" /></td>
                            <td><input type="email" id="user-email" placeholder="johndoe@example.com" /></td>
                            <td>
                                <select id="user-department">
                                    <option value="" selected disabled hidden>Select</option>
                                    <option value="Training Team">Training Team</option>
                                    <option value="Sales">Sales</option>
                                </select>
                            </td>
                            <td>
                                <select id="user-position">
                                    <option value="" selected disabled hidden>Select</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Team Leader">Team Leader</option>
                                    <option value="Trainer">Trainer</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="5" style="text-align: center;">
                                <button id="add-user-button" class="add-button">Add Trainer</button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        <div class="middle-wrapper-excel">
            <div class="import-excel-container">
                <h2><i class="fas fa-file-excel"></i> Import Trainers from Excel</h2>
                <form id="importExcelForm">
                    <div class="form-group">
                        <label for="excelFile"><i class="fas fa-upload"></i> Choose Excel File:</label>
                        <input type="file" id="excelFile" accept=".xlsx, .xls" required />
                    </div>
                    <button class="import-button" type="submit"><i class="fas fa-file-import"></i> Import</button>
                </form>
                <p class="help-text">* Only .xls and .xlsx files are allowed. Ensure the file has columns: Name, Email, Department, Position, Password.</p>
            </div>
        </div>
        <div class="table-container" id="training-skills">
            <table class="imported-trainers" id="imported-trainers">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Department</th>
                        <th>Position</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-list">
                </tbody>
            </table>
        </div>
    </main>
</div>
<script type="module">
/*** Constants and Storage Variables ***/
const SUPABASE_URL = "https://mypzlemscnzlplzejlbh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im15cHpsZW1zY256bHBsemVqbGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjk4MzUsImV4cCI6MjA3MDY0NTgzNX0.nkfCNHJtCOoFbNZke0pZMtGNcKjtzJXZ7Yhg3n7Zr5w";
const LOGIN_PAGE = "login.html";
let trainerStorage = [];

// Initialize Supabase Client
let supabase;
try {
    supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log("Supabase client initialized successfully.");
} catch (err) {
    console.error("Error initializing Supabase client:", err);
    alert("Failed to connect to the database. Please check the console for details.");
}

// DOM Elements
const tableBody = document.querySelector("#users-list");
const importExcelForm = document.getElementById("importExcelForm");
const excelFileInput = document.getElementById("excelFile");
const addUserButton = document.getElementById("add-user-button");

/*** Utility Functions ***/
function redirectToLoginIfNotLoggedIn() {
    if (!sessionStorage.getItem("isLoggedIn")) {
        window.location.href = LOGIN_PAGE;
    }
}

async function loadTrainerStorage() {
    try {
        const { data, error } = await supabase
            .from("trainers")
            .select("*")
            .order("id", { ascending: true });
        if (error) throw error;
        trainerStorage = data.map(row => ({
            id: row.id,
            name: row.name || "",
            email: row.email || "",
            department: row.department || "",
            position: row.position || "",
            password: row.password || ""
        }));
        console.log("Trainers loaded:", trainerStorage);
        populateTable();
    } catch (err) {
        console.error("Error loading trainers from Supabase:", err);
        alert("Failed to load trainers. Please check the console for details.");
        trainerStorage = [];
        populateTable();
    }
}

async function saveTrainerStorage(trainer) {
    try {
        const { error } = await supabase
            .from("trainers")
            .upsert(trainer, { onConflict: "id" });
        if (error) throw error;
        console.log("Trainer data saved to Supabase:", trainer);
    } catch (err) {
        console.error("Error saving to Supabase:", err);
        alert("Failed to save trainer. Please check the console for details.");
    }
}

async function deleteTrainer(id) {
    try {
        const { error } = await supabase
            .from("trainers")
            .delete()
            .eq("id", id);
        if (error) throw error;
        console.log("Trainer deleted from Supabase, ID:", id);
    } catch (err) {
        console.error("Error deleting from Supabase:", err);
        alert("Failed to delete trainer. Please check the console for details.");
    }
}

/*** Table Population ***/
function populateTable() {
    if (!tableBody) {
        console.error("Table body not found.");
        alert("Table body not found. Please check the HTML structure.");
        return;
    }
    tableBody.innerHTML = "";
    trainerStorage.forEach((user, index) => {
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
            <td><input type="text" value="${user.name || ""}" disabled /></td>
            <td><input type="email" value="${user.email || ""}" disabled /></td>
            <td><input type="text" value="${user.department || ""}" disabled /></td>
            <td><input type="text" value="${user.position || ""}" disabled /></td>
            <td style="display: none;"><input type="text" value="${user.password || ""}" disabled /></td>
            <td>
                <button class="edit-trainer-button" data-index="${index}">Edit</button>
                <button class="save-trainer-button" data-index="${index}" style="display: none;">Save</button>
                <button class="reset-trainer-password-button" data-index="${index}" style="display: none;">Reset Password</button>
                <button class="remove-trainer-button" data-index="${index}" style="display: none;">Remove</button>
            </td>
        `;
        tableBody.appendChild(newRow);
        attachButtonEventListeners(newRow, index);
    });
}

/*** Button Event Listeners ***/
function attachButtonEventListeners(row, index) {
    const editButton = row.querySelector(".edit-trainer-button");
    const saveButton = row.querySelector(".save-trainer-button");
    const removeButton = row.querySelector(".remove-trainer-button");

    if (!editButton || !saveButton || !removeButton) {
        console.error("Button elements not found in row:", index);
        return;
    }

    editButton.addEventListener("click", () => editUser(index, row));
    saveButton.addEventListener("click", () => saveUser(index, row));
    removeButton.addEventListener("click", () => removeUser(index));
}

/*** User Actions ***/
function editUser(index, row) {
    const editButton = row.querySelector(".edit-trainer-button");
    const saveButton = row.querySelector(".save-trainer-button");
    const resetButton = row.querySelector(".reset-trainer-password-button");
    const removeButton = row.querySelector(".remove-trainer-button");

    editButton.style.display = "none";
    saveButton.style.display = "inline-block";
    resetButton.style.display = "inline-block";
    removeButton.style.display = "inline-block";

    const inputs = row.querySelectorAll("input");
    inputs.forEach(input => input.removeAttribute("disabled"));

    const positionCell = row.children[3];
    const currentPosition = positionCell.querySelector("input").value;
    positionCell.innerHTML = `
        <select>
            <option value="Manager" ${currentPosition === "Manager" ? "selected" : ""}>Manager</option>
            <option value="Team Leader" ${currentPosition === "Team Leader" ? "selected" : ""}>Team Leader</option>
            <option value="Trainer" ${currentPosition === "Trainer" ? "selected" : ""}>Trainer</option>
        </select>
    `;
}

async function saveUser(index, row) {
    const inputs = row.querySelectorAll("input, select");
    if (inputs.length < 5) {
        console.error("Not enough inputs in row for saving:", index);
        alert("Error: Incomplete form data.");
        return;
    }
    const trainer = {
        id: trainerStorage[index].id,
        name: inputs[0].value.trim(),
        email: inputs[1].value.trim(),
        department: inputs[2].value.trim(),
        position: inputs[3].value.trim(),
        password: inputs[4].value.trim()
    };
    if (!trainer.name || !trainer.email || !trainer.department || !trainer.position) {
        alert("Please fill in all required fields.");
        return;
    }
    trainerStorage[index] = trainer;
    await saveTrainerStorage(trainer);
    await loadTrainerStorage();
    alert("Trainer updated successfully.");
}

async function removeUser(index) {
    const id = trainerStorage[index].id;
    trainerStorage.splice(index, 1);
    await deleteTrainer(id);
    await loadTrainerStorage();
    alert("Trainer removed successfully.");
}

async function addUser() {
    const nameInput = document.getElementById("user-name");
    const emailInput = document.getElementById("user-email");
    const departmentInput = document.getElementById("user-department");
    const positionInput = document.getElementById("user-position");

    if (!nameInput || !emailInput || !departmentInput || !positionInput) {
        console.error("Form inputs not found.");
        alert("Error: Form inputs not found.");
        return;
    }

    const trainer = {
        name: nameInput.value.trim(),
        email: emailInput.value.trim(),
        department: departmentInput.value.trim(),
        position: positionInput.value.trim(),
        password: "" // Password can be set via reset if needed
    };

    if (!trainer.name || !trainer.email || !trainer.department || !trainer.position) {
        alert("Please fill in all required fields.");
        return;
    }

    try {
        const { error } = await supabase
            .from("trainers")
            .insert([trainer]);
        if (error) throw error;
        console.log("Trainer added to Supabase:", trainer);
        await loadTrainerStorage();
        nameInput.value = "";
        emailInput.value = "";
        departmentInput.value = "";
        positionInput.value = "";
        alert("Trainer added successfully.");
    } catch (err) {
        console.error("Error adding trainer to Supabase:", err);
        alert("Failed to add trainer. Please check the console for details.");
    }
}

/*** Excel Import ***/
async function handleExcelImport(event) {
    event.preventDefault();
    const file = excelFileInput.files[0];
    if (!file) {
        alert("Please select an Excel file.");
        return;
    }
    const reader = new FileReader();
    reader.onload = async function (e) {
        try {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: "binary" });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            if (rows.length < 2) {
                alert("Excel file is empty or has no data rows.");
                return;
            }

            const trainers = rows.slice(1).map(row => ({
                name: (row[0] || "").toString().trim(),
                email: (row[1] || "").toString().trim(),
                department: (row[2] || "").toString().trim(),
                position: (row[3] || "").toString().trim(),
                password: (row[4] || "").toString().trim()
            })).filter(trainer => trainer.name && trainer.email && trainer.department && trainer.position);

            if (trainers.length === 0) {
                alert("No valid trainer data found in the Excel file.");
                return;
            }

            const { error } = await supabase
                .from("trainers")
                .insert(trainers);
            if (error) throw error;
            console.log("Trainers imported to Supabase:", trainers);
            await loadTrainerStorage();
            excelFileInput.value = "";
            alert(`Successfully imported ${trainers.length} trainers.`);
        } catch (err) {
            console.error("Error importing trainers to Supabase:", err);
            alert("Failed to import trainers. Please check the console for details.");
        }
    };
    reader.onerror = () => {
        console.error("Error reading Excel file.");
        alert("Error reading Excel file. Please ensure it's a valid .xls or .xlsx file.");
    };
    reader.readAsBinaryString(file);
}

/*** Initialization ***/
document.addEventListener("DOMContentLoaded", async function () {
    console.log("DOM loaded, initializing...");
    redirectToLoginIfNotLoggedIn();
    if (!supabase) {
        alert("Supabase client not initialized. Check SUPABASE_URL and SUPABASE_KEY.");
        return;
    }
    await loadTrainerStorage();
    if (importExcelForm) {
        importExcelForm.addEventListener("submit", handleExcelImport);
        console.log("Excel import form listener attached.");
    } else {
        console.error("Import form not found.");
    }
    if (addUserButton) {
        addUserButton.addEventListener("click", addUser);
        console.log("Add user button listener attached.");
    } else {
        console.error("Add user button not found.");
    }
});
</script>
</body>
</html>
